## トランザクション

### トランザクション隔離レベル
  - トランザクション内の処理に対してどの程度他の処理が介入できるかを表す

| 隔離レベル          | ダーティリード | 反復不可能な読み取り | ファントムリード |
|---------------------|---------------|---------------------|-----------------|
| READ UNCOMMITTED    | 可能性あり    | 可能性あり          | 可能性あり      |
| READ COMMITTED      | 安全          | 可能性あり          | 可能性あり      |
| REPEATABLE READ     | 安全          | 安全                | 可能性あり      |
| SERIALIZABLE        | 安全          | 安全                | 安全            |

- 発生しうる事象
  - ダーティリード
    - 読み書き後のコミットされていないデータを同時に実行されている他のトランザクションが読み込んでしまうこと
  - 反服不能読み取り
    - トランザクション内で読み込んだデータを再度読み込んだ時、同じデータを読み込めない事象。再読み込みするまでに他のトランザクションが更新しコミットしたデータを参照することで発生する
  - ファントムリード
    - トランザクション中に他取らんザクションによってデータが挿入/削除され、整合性が合わなくなること

### セーブポイント 
トランザクションがロールバックされてもSAVEPOINTを定義している場合、SAVEPOINTまでの操作は確定になる

### ロック
自分のトランザクションがコミットかロールバックするまで、処理中のデータを他のトランザクションから更新、削除できないようにする
複数のトランザクション実行時に影響があり、性能低下を招く原因となるため不要なロックは極力避ける

Postgresqlの場合は`行単位`・`テーブル単位`でロックが可能

### PostgreSQLの仕組み
クライアント(psql)とバックエンド

#### 通信におけるプロトコル
HTTPやFTP同様にPostgres専用プロトコルのlibpqなるものがある。

#### メモリ構造
- 共有メモリバッファ
  - テーブルやインデックスのデータをメモリ上にキャッシュしておくためのバッファ
  - ディスク読み取り回数を減らしパフォーマンスを向上させる
  - shared_buffersにサイズを設定可能
- WALバッファ
  - 変更を記録したログ
  - wal_buffersにサイズ設定
- ワークメモリ
  - SQL実行時、ソートやハッシュなどためにバックエンドごとに確保されるメモリ
  - サイズ不足すると一時ファイルを作成し、ディスクアクセスを発生させるため性能が低下
  - work_memにサイズ設定
- メンテナンスワークメモリ
  - VACCUMやCREATE INDEXなどのメンテナンス実行時にバックエンドごとに確保されるメモリ
  - メンテナンスを効率よく実行できる
  - maintenance_work_memに設定

